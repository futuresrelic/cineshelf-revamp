<?php
/**
 * CineShelf v3.0 - Main API Endpoint  
 * NEW: Groups/Family Collections & Borrowing System
 */

require_once __DIR__ . '/../config/config.php';

// CORS Headers
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, X-User-ID');
header('Content-Type: application/json');

// Handle preflight
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Get request data
$input = json_decode(file_get_contents('php://input'), true) ?? [];
$action = $input['action'] ?? '';
$user = $input['user'] ?? DEFAULT_USER;

// Basic validation
if (empty($action)) {
    jsonResponse(false, null, 'Action required');
}

try {
    $db = getDb();
    
    // Get or create user
    $currentUser = getOrCreateUser($db, $user);
    $userId = $currentUser['id'];
    
    // Route to appropriate action
    switch ($action) {
        
        // ========================================
        // MOVIE SEARCH ACTIONS
        // ========================================
        
        case 'search_movie':
            $query = sanitize($input['query'] ?? '', 100);
            
            if (empty($query)) {
                jsonResponse(false, null, 'Search query required');
            }
            
            $url = TMDB_BASE_URL . '/search/movie?api_key=' . TMDB_API_KEY . '&query=' . urlencode($query);
            $response = file_get_contents($url);
            
            if ($response === false) {
                jsonResponse(false, null, 'TMDB API request failed');
            }
            
            $data = json_decode($response, true);
            jsonResponse(true, $data['results'] ?? []);
            break;
            
        case 'search_multi':
            $query = sanitize($input['query'] ?? '', 100);
            
            if (empty($query)) {
                jsonResponse(false, null, 'Search query required');
            }
            
            $url = TMDB_BASE_URL . '/search/multi?api_key=' . TMDB_API_KEY . '&query=' . urlencode($query);
            $response = file_get_contents($url);
            
            if ($response === false) {
                jsonResponse(false, null, 'TMDB API request failed');
            }
            
            $data = json_decode($response, true);
            
            // Filter to only movies and TV shows
            $results = array_filter($data['results'] ?? [], function($item) {
                return in_array($item['media_type'], ['movie', 'tv']);
            });
            
            jsonResponse(true, array_values($results));
            break;
        
        case 'get_movie':
            $tmdbId = sanitize($input['tmdb_id'] ?? '', 20);
            $mediaType = sanitize($input['media_type'] ?? 'movie', 20);
            
            if (empty($tmdbId)) {
                jsonResponse(false, null, 'TMDB ID required');
            }
            
            $endpoint = $mediaType === 'tv' ? '/tv/' : '/movie/';
            $url = TMDB_BASE_URL . $endpoint . $tmdbId . '?api_key=' . TMDB_API_KEY . '&append_to_response=release_dates,content_ratings,credits';
            
            $response = file_get_contents($url);
            
            if ($response === false) {
                jsonResponse(false, null, 'TMDB API request failed');
            }
            
            $data = json_decode($response, true);
            
            // Get certification
            $certification = null;
            if ($mediaType === 'tv' && isset($data['content_ratings']['results'])) {
                foreach ($data['content_ratings']['results'] as $rating) {
                    if ($rating['iso_3166_1'] === 'US') {
                        $certification = $rating['rating'];
                        break;
                    }
                }
            } elseif (isset($data['release_dates']['results'])) {
                foreach ($data['release_dates']['results'] as $release) {
                    if ($release['iso_3166_1'] === 'US') {
                        foreach ($release['release_dates'] as $date) {
                            if (!empty($date['certification'])) {
                                $certification = $date['certification'];
                                break 2;
                            }
                        }
                    }
                }
            }
            
            $genres = implode(', ', array_column($data['genres'] ?? [], 'name'));
            
            if ($mediaType === 'tv') {
                jsonResponse(true, [
                    'id' => $data['id'],
                    'title' => $data['name'],
                    'year' => isset($data['first_air_date']) ? intval(substr($data['first_air_date'], 0, 4)) : null,
                    'poster_path' => $data['poster_path'] ?? null,
                    'backdrop_path' => $data['backdrop_path'] ?? null,
                    'overview' => $data['overview'] ?? null,
                    'rating' => $data['vote_average'] ?? null,
                    'runtime' => isset($data['episode_run_time'][0]) ? $data['episode_run_time'][0] : null,
                    'genre' => $genres,
                    'media_type' => 'tv',
                    'director' => isset($data['created_by'][0]['name']) ? $data['created_by'][0]['name'] : null,
                    'certification' => $certification
                ]);
            } else {
                // Get director
                $director = null;
                if (isset($data['credits']['crew'])) {
                    foreach ($data['credits']['crew'] as $person) {
                        if ($person['job'] === 'Director') {
                            $director = $person['name'];
                            break;
                        }
                    }
                }
                
                jsonResponse(true, [
                    'id' => $data['id'],
                    'title' => $data['title'],
                    'year' => isset($data['release_date']) ? intval(substr($data['release_date'], 0, 4)) : null,
                    'poster_path' => $data['poster_path'] ?? null,
                    'backdrop_path' => $data['backdrop_path'] ?? null,
                    'overview' => $data['overview'] ?? null,
                    'rating' => $data['vote_average'] ?? null,
                    'runtime' => $data['runtime'] ?? null,
                    'genre' => $genres,
                    'imdb_id' => $data['imdb_id'] ?? null,
                    'media_type' => 'movie',
                    'director' => $director,
                    'certification' => $certification
                ]);
            }
            break;
        
        // ========================================
        // COPY ACTIONS (Collection Management)
        // ========================================
        
        case 'add_copy':
            $tmdbId = sanitize($input['tmdb_id'] ?? '', 20);
            $mediaType = sanitize($input['media_type'] ?? 'movie', 20);
            $format = sanitize($input['format'] ?? 'DVD', 50);
            $edition = sanitize($input['edition'] ?? '', 100);
            $region = sanitize($input['region'] ?? '', 50);
            $condition = sanitize($input['condition'] ?? 'Good', 50);
            $notes = sanitize($input['notes'] ?? '', 500);
            $barcode = sanitize($input['barcode'] ?? '', 50);
            
            if (empty($tmdbId)) {
                jsonResponse(false, null, 'TMDB ID required');
            }
            
            // Get or create movie
            $stmt = $db->prepare("SELECT id FROM movies WHERE tmdb_id = ?");
            $stmt->execute([$tmdbId]);
            $movie = $stmt->fetch();
            
            if (!$movie) {
                // Fetch from TMDB first
                $endpoint = $mediaType === 'tv' ? '/tv/' : '/movie/';
                $url = TMDB_BASE_URL . $endpoint . $tmdbId . '?api_key=' . TMDB_API_KEY;
                $response = file_get_contents($url);
                
                if ($response === false) {
                    jsonResponse(false, null, 'Failed to fetch movie from TMDB');
                }
                
                $data = json_decode($response, true);
                $genres = implode(', ', array_column($data['genres'] ?? [], 'name'));
                
                // Insert movie
                $stmt = $db->prepare("
                    INSERT INTO movies (tmdb_id, title, year, poster_url, overview, rating, runtime, genre, media_type)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                ");
                
                $title = $mediaType === 'tv' ? $data['name'] : $data['title'];
                $releaseDate = $mediaType === 'tv' ? ($data['first_air_date'] ?? null) : ($data['release_date'] ?? null);
                $year = $releaseDate ? intval(substr($releaseDate, 0, 4)) : null;
                
                $stmt->execute([
                    $tmdbId,
                    $title,
                    $year,
                    isset($data['poster_path']) ? TMDB_IMAGE_BASE . $data['poster_path'] : null,
                    $data['overview'] ?? null,
                    $data['vote_average'] ?? null,
                    $data['runtime'] ?? ($data['episode_run_time'][0] ?? null),
                    $genres,
                    $mediaType
                ]);
                
                $movieId = $db->lastInsertId();
            } else {
                $movieId = $movie['id'];
            }
            
            // Add copy
            $stmt = $db->prepare("
                INSERT INTO copies (user_id, movie_id, format, edition, region, condition, notes, barcode)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ");
            
            $stmt->execute([$userId, $movieId, $format, $edition, $region, $condition, $notes, $barcode]);
            
            logAction($db, $userId, 'copy_added', 'copy', $db->lastInsertId());
            
            jsonResponse(true, ['copy_id' => $db->lastInsertId()]);
            break;
        
        case 'list_collection':
            $stmt = $db->prepare("
                SELECT 
                    c.id as copy_id,
                    c.format,
                    c.edition,
                    c.region,
                    c.condition,
                    c.notes,
                    c.barcode,
                    c.created_at,
                    m.id as movie_id,
                    m.tmdb_id,
                    m.title,
                    m.display_title,
                    m.year,
                    m.poster_url,
                    m.rating,
                    m.runtime,
                    m.genre,
                    m.media_type,
                    m.overview,
                    m.director,
                    m.certification,
                    COUNT(*) OVER (PARTITION BY m.id) as copy_count
                FROM copies c
                JOIN movies m ON c.movie_id = m.id
                WHERE c.user_id = ?
                ORDER BY COALESCE(m.display_title, m.title) ASC
            ");
            $stmt->execute([$userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        case 'delete_copy':
            $copyId = intval($input['copy_id'] ?? 0);
            
            $stmt = $db->prepare("DELETE FROM copies WHERE id = ? AND user_id = ?");
            $stmt->execute([$copyId, $userId]);
            
            logAction($db, $userId, 'copy_deleted', 'copy', $copyId);
            
            jsonResponse(true, ['deleted' => $copyId]);
            break;
        
case 'update_copy':
    $copyId = intval($input['copy_id'] ?? 0);
    $format = sanitize($input['format'] ?? '', 50);
    $edition = sanitize($input['edition'] ?? '', 100);
    $region = sanitize($input['region'] ?? '', 20);
    $condition = sanitize($input['condition'] ?? '', 20);
    $notes = sanitize($input['notes'] ?? '', 500);
    
    if (empty($copyId) || empty($format)) {
        jsonResponse(false, null, 'Copy ID and format required');
    }
    
    // Verify ownership
    $stmt = $db->prepare("SELECT user_id FROM copies WHERE id = ?");
    $stmt->execute([$copyId]);
    $copy = $stmt->fetch();
    
    if (!$copy) {
        jsonResponse(false, null, 'Copy not found');
    }
    
    if ($copy['user_id'] != $userId) {
        jsonResponse(false, null, 'Not authorized to edit this copy');
    }
    
    // Update copy
    $stmt = $db->prepare("
        UPDATE copies 
        SET format = ?, edition = ?, region = ?, condition = ?, notes = ?
        WHERE id = ? AND user_id = ?
    ");
    $stmt->execute([$format, $edition, $region, $condition, $notes, $copyId, $userId]);
    
    logAction($db, $userId, 'copy_updated', 'copy', $copyId);  // â† FIXED!
    
    jsonResponse(true, ['copy_id' => $copyId]);
    break;
        
        case 'get_movie_copies':
            $movieId = intval($input['movie_id'] ?? 0);
            
            $stmt = $db->prepare("
                SELECT * FROM copies
                WHERE movie_id = ? AND user_id = ?
                ORDER BY created_at DESC
            ");
            $stmt->execute([$movieId, $userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;

case 'update_display_title':
    $movieId = intval($input['movie_id'] ?? 0);
    $displayTitle = sanitize($input['display_title'] ?? '', 500);
    
    if (empty($movieId)) {
        jsonResponse(false, null, 'Movie ID required');
    }
    
    // Empty string means revert to original title
    $stmt = $db->prepare("
        UPDATE movies 
        SET display_title = ?
        WHERE id = ?
    ");
    $stmt->execute([empty($displayTitle) ? null : $displayTitle, $movieId]);
    
    logAction($db, $userId, 'display_title_updated', 'movie', $movieId);
    
    jsonResponse(true, ['movie_id' => $movieId, 'display_title' => $displayTitle]);
    break;

case 'get_movie_posters':
    $tmdbId = sanitize($input['tmdb_id'] ?? '', 20);
    $mediaType = sanitize($input['media_type'] ?? 'movie', 20);
    
    if (empty($tmdbId)) {
        jsonResponse(false, null, 'TMDB ID required');
    }
    
    // Fetch posters from TMDB
    $endpoint = $mediaType === 'tv' ? '/tv/' : '/movie/';
    $url = TMDB_BASE_URL . $endpoint . $tmdbId . '/images?api_key=' . TMDB_API_KEY;
    
    $response = file_get_contents($url);
    
    if ($response === false) {
        jsonResponse(false, null, 'Failed to fetch posters from TMDB');
    }
    
    $data = json_decode($response, true);
    $posters = $data['posters'] ?? [];
    
    // Sort by vote_average (highest rated first)
    usort($posters, function($a, $b) {
        return ($b['vote_average'] ?? 0) <=> ($a['vote_average'] ?? 0);
    });
    
    // Return top 20 posters
    jsonResponse(true, array_slice($posters, 0, 20));
    break;

case 'update_movie_poster':
    $movieId = intval($input['movie_id'] ?? 0);
    $posterPath = sanitize($input['poster_path'] ?? '', 200);
    
    if (empty($movieId) || empty($posterPath)) {
        jsonResponse(false, null, 'Movie ID and poster path required');
    }
    
    // Build full poster URL
    $posterUrl = TMDB_IMAGE_BASE . $posterPath;
    
    // Update movie poster
    $stmt = $db->prepare("
        UPDATE movies 
        SET poster_url = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
    ");
    $stmt->execute([$posterUrl, $movieId]);
    
    logAction($db, $userId, 'poster_updated', 'movie', $movieId);
    
    jsonResponse(true, ['movie_id' => $movieId, 'poster_url' => $posterUrl]);
    break;

// ========================================
// WISHLIST ACTIONS
// ========================================
        
        case 'add_wishlist':
            $tmdbId = sanitize($input['tmdb_id'] ?? '', 20);
            $mediaType = sanitize($input['media_type'] ?? 'movie', 20);
            $priority = intval($input['priority'] ?? 0);
            $targetFormat = sanitize($input['target_format'] ?? '', 50);
            $notes = sanitize($input['notes'] ?? '', 500);
            
            if (empty($tmdbId)) {
                jsonResponse(false, null, 'TMDB ID required');
            }
            
            // Get or create movie (same as add_copy)
            $stmt = $db->prepare("SELECT id FROM movies WHERE tmdb_id = ?");
            $stmt->execute([$tmdbId]);
            $movie = $stmt->fetch();
            
            if (!$movie) {
                $endpoint = $mediaType === 'tv' ? '/tv/' : '/movie/';
                $url = TMDB_BASE_URL . $endpoint . $tmdbId . '?api_key=' . TMDB_API_KEY;
                $response = file_get_contents($url);
                
                if ($response === false) {
                    jsonResponse(false, null, 'Failed to fetch from TMDB');
                }
                
                $data = json_decode($response, true);
                $genres = implode(', ', array_column($data['genres'] ?? [], 'name'));
                
                $stmt = $db->prepare("
                    INSERT INTO movies (tmdb_id, title, year, poster_url, overview, rating, runtime, genre, media_type)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                ");
                
                $title = $mediaType === 'tv' ? $data['name'] : $data['title'];
                $releaseDate = $mediaType === 'tv' ? ($data['first_air_date'] ?? null) : ($data['release_date'] ?? null);
                $year = $releaseDate ? intval(substr($releaseDate, 0, 4)) : null;
                
                $stmt->execute([
                    $tmdbId,
                    $title,
                    $year,
                    isset($data['poster_path']) ? TMDB_IMAGE_BASE . $data['poster_path'] : null,
                    $data['overview'] ?? null,
                    $data['vote_average'] ?? null,
                    $data['runtime'] ?? ($data['episode_run_time'][0] ?? null),
                    $genres,
                    $mediaType
                ]);
                
                $movieId = $db->lastInsertId();
            } else {
                $movieId = $movie['id'];
            }
            
            // Add to wishlist
            $stmt = $db->prepare("
                INSERT OR REPLACE INTO wishlist (user_id, movie_id, priority, target_format, notes)
                VALUES (?, ?, ?, ?, ?)
            ");
            
            $stmt->execute([$userId, $movieId, $priority, $targetFormat, $notes]);
            
            logAction($db, $userId, 'wishlist_added', 'wishlist', $movieId);
            
            jsonResponse(true, ['movie_id' => $movieId]);
            break;
        
        case 'list_wishlist':
            $stmt = $db->prepare("
                SELECT 
                    w.*,
                    m.id as movie_id,
                    m.title,
                    m.year,
                    m.poster_url,
                    m.rating,
                    m.runtime,
                    m.genre,
                    m.tmdb_id,
                    m.overview,
                    m.director,
                    m.certification,
                    m.media_type
                FROM wishlist w
                JOIN movies m ON w.movie_id = m.id
                WHERE w.user_id = ?
                ORDER BY w.priority DESC, m.title ASC
            ");
            $stmt->execute([$userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        case 'remove_wishlist':
            $movieId = intval($input['movie_id'] ?? 0);
            
            $stmt = $db->prepare("DELETE FROM wishlist WHERE movie_id = ? AND user_id = ?");
            $stmt->execute([$movieId, $userId]);
            
            logAction($db, $userId, 'wishlist_removed', 'wishlist', $movieId);
            
            jsonResponse(true, ['deleted' => $movieId]);
            break;
        
        // ========================================
        // RESOLVE ACTIONS
        // ========================================
        
        case 'list_unresolved':
            $stmt = $db->prepare("
                SELECT DISTINCT
                    m.id as movie_id,
                    m.tmdb_id,
                    m.title,
                    m.poster_url,
                    m.year,
                    COUNT(c.id) as copy_count
                FROM movies m
                JOIN copies c ON c.movie_id = m.id
                WHERE c.user_id = ?
                  AND m.tmdb_id LIKE 'unresolved_%'
                GROUP BY m.id
                ORDER BY m.title ASC
            ");
            $stmt->execute([$userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
case 'resolve_movie':
    $movieId = intval($input['movie_id'] ?? 0);
    $tmdbId = sanitize($input['tmdb_id'] ?? '', 20);
    $mediaType = sanitize($input['media_type'] ?? 'movie', 20);
    $confirmMerge = $input['confirm_merge'] ?? false;
    
    if (empty($movieId) || empty($tmdbId)) {
        jsonResponse(false, null, 'Movie ID and TMDB ID required');
    }
    
    // Check if this TMDB ID already exists in database
    $stmt = $db->prepare("SELECT id, title FROM movies WHERE tmdb_id = ?");
    $stmt->execute([$tmdbId]);
    $existingMovie = $stmt->fetch();
    
    if ($existingMovie) {
        // Movie already exists!
        
        if (!$confirmMerge) {
            // First time - ask user to confirm
            jsonResponse(false, [
                'already_exists' => true,
                'existing_movie' => $existingMovie,
                'unresolved_movie_id' => $movieId
            ], 'This movie already exists in your collection');
        }
        
        // User confirmed - merge the unresolved copies into existing movie
        
        // Get all copies of the unresolved movie
        $stmt = $db->prepare("SELECT id FROM copies WHERE movie_id = ? AND user_id = ?");
        $stmt->execute([$movieId, $userId]);
        $copies = $stmt->fetchAll();
        
        // Update copies to point to existing movie
        $stmt = $db->prepare("UPDATE copies SET movie_id = ? WHERE movie_id = ? AND user_id = ?");
        $stmt->execute([$existingMovie['id'], $movieId, $userId]);
        
        // Check if unresolved movie has any other copies from other users
        $stmt = $db->prepare("SELECT COUNT(*) FROM copies WHERE movie_id = ?");
        $stmt->execute([$movieId]);
        $remainingCopies = $stmt->fetchColumn();
        
        // If no other copies, delete the unresolved movie entry
        if ($remainingCopies == 0) {
            $stmt = $db->prepare("DELETE FROM movies WHERE id = ?");
            $stmt->execute([$movieId]);
        }
        
        logAction($db, $userId, 'movie_merged', 'movie', $existingMovie['id']);
        
        jsonResponse(true, [
            'movie_id' => $existingMovie['id'],
            'title' => $existingMovie['title'],
            'merged' => true,
            'copies_moved' => count($copies)
        ]);
        
    } else {
        // Movie doesn't exist - fetch from TMDB and update
        
        $endpoint = $mediaType === 'tv' ? '/tv/' : '/movie/';
        $url = TMDB_BASE_URL . $endpoint . $tmdbId . '?api_key=' . TMDB_API_KEY;
        $response = file_get_contents($url);
        
        if ($response === false) {
            jsonResponse(false, null, 'Failed to fetch from TMDB');
        }
        
        $data = json_decode($response, true);
        $genres = implode(', ', array_column($data['genres'] ?? [], 'name'));
        
        // Update movie record
        $stmt = $db->prepare("
            UPDATE movies SET
                tmdb_id = ?,
                title = ?,
                year = ?,
                poster_url = ?,
                overview = ?,
                rating = ?,
                runtime = ?,
                genre = ?,
                media_type = ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ");
        
        $title = $mediaType === 'tv' ? $data['name'] : $data['title'];
        $releaseDate = $mediaType === 'tv' ? ($data['first_air_date'] ?? null) : ($data['release_date'] ?? null);
        $year = $releaseDate ? intval(substr($releaseDate, 0, 4)) : null;
        
        $stmt->execute([
            $tmdbId,
            $title,
            $year,
            isset($data['poster_path']) ? TMDB_IMAGE_BASE . $data['poster_path'] : null,
            $data['overview'] ?? null,
            $data['vote_average'] ?? null,
            $data['runtime'] ?? ($data['episode_run_time'][0] ?? null),
            $genres,
            $mediaType,
            $movieId
        ]);
        
        jsonResponse(true, ['movie_id' => $movieId, 'title' => $title]);
    }
    break;
            
        case 'add_unresolved':
            $title = sanitize($input['title'] ?? '', 200);
            
            if (empty($title)) {
                jsonResponse(false, null, 'Title required');
            }
            
            // Create unresolved movie entry
            $unresolvedId = 'unresolved_' . md5($title . time() . $userId);
            
            $stmt = $db->prepare("
                INSERT INTO movies (tmdb_id, title, year, poster_url)
                VALUES (?, ?, NULL, NULL)
            ");
            $stmt->execute([$unresolvedId, $title]);
            $movieId = $db->lastInsertId();
            
            // Create copy
            $stmt = $db->prepare("
                INSERT INTO copies (user_id, movie_id, format, condition, created_at)
                VALUES (?, ?, 'DVD', 'Good', datetime('now'))
            ");
            $stmt->execute([$userId, $movieId]);
            
            jsonResponse(true, ['movie_id' => $movieId, 'title' => $title]);
            break;
        
        // ========================================
        // USER ACTIONS
        // ========================================
        
        case 'get_user_settings':
            jsonResponse(true, json_decode($currentUser['settings_json'] ?? '{}', true));
            break;
        
        case 'save_user_settings':
            $settings = $input['settings'] ?? [];
            
            $stmt = $db->prepare("UPDATE users SET settings_json = ? WHERE id = ?");
            $stmt->execute([json_encode($settings), $userId]);
            
            jsonResponse(true, $settings);
            break;
        
        // ========================================
        // STATISTICS
        // ========================================
        
        case 'get_stats':
            $stats = [];
            
            $stmt = $db->prepare("SELECT COUNT(*) as count FROM copies WHERE user_id = ?");
            $stmt->execute([$userId]);
            $stats['total_copies'] = $stmt->fetch()['count'];
            
            $stmt = $db->prepare("SELECT COUNT(DISTINCT movie_id) as count FROM copies WHERE user_id = ?");
            $stmt->execute([$userId]);
            $stats['unique_movies'] = $stmt->fetch()['count'];
            
            $stmt = $db->prepare("SELECT COUNT(*) as count FROM wishlist WHERE user_id = ?");
            $stmt->execute([$userId]);
            $stats['wishlist_count'] = $stmt->fetch()['count'];
            
            jsonResponse(true, $stats);
            break;
        
        // ========================================
        // GROUP MANAGEMENT (NEW IN V3.0)
        // ========================================
        
        case 'create_group':
            $name = sanitize($input['name'] ?? '', 100);
            $description = sanitize($input['description'] ?? '', 500);
            
            if (empty($name)) {
                jsonResponse(false, null, 'Group name required');
            }
            
            // Create group
            $stmt = $db->prepare("
                INSERT INTO groups (name, description, created_by)
                VALUES (?, ?, ?)
            ");
            $stmt->execute([$name, $description, $userId]);
            $groupId = $db->lastInsertId();
            
            // Add creator as admin
            $stmt = $db->prepare("
                INSERT INTO group_members (group_id, user_id, role)
                VALUES (?, ?, 'admin')
            ");
            $stmt->execute([$groupId, $userId]);
            
            logAction($db, $userId, 'group_created', 'group', $groupId);
            
            jsonResponse(true, ['group_id' => $groupId, 'name' => $name]);
            break;
        
        case 'list_groups':
            $stmt = $db->prepare("
                SELECT 
                    g.id,
                    g.name,
                    g.description,
                    g.created_at,
                    gm.role,
                    u.username as creator_name,
                    COUNT(DISTINCT gm2.user_id) as member_count
                FROM groups g
                JOIN group_members gm ON g.id = gm.group_id
                JOIN users u ON g.created_by = u.id
                LEFT JOIN group_members gm2 ON g.id = gm2.group_id
                WHERE gm.user_id = ?
                GROUP BY g.id
                ORDER BY g.name ASC
            ");
            $stmt->execute([$userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        case 'add_group_member':
            $groupId = intval($input['group_id'] ?? 0);
            $memberUsername = sanitize($input['username'] ?? '', 50);
            
            if (empty($groupId) || empty($memberUsername)) {
                jsonResponse(false, null, 'Group ID and username required');
            }
            
            // Check if user is admin
            $stmt = $db->prepare("
                SELECT role FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $userId]);
            $membership = $stmt->fetch();
            
            if (!$membership || $membership['role'] !== 'admin') {
                jsonResponse(false, null, 'Only group admins can add members');
            }
            
            // Get or create user (auto-creates if doesn't exist)
            $newMember = getOrCreateUser($db, $memberUsername);
            
            // Add to group
            try {
                $stmt = $db->prepare("
                    INSERT INTO group_members (group_id, user_id, role)
                    VALUES (?, ?, 'member')
                ");
                $stmt->execute([$groupId, $newMember['id']]);
                
                logAction($db, $userId, 'member_added', 'group', $groupId, [
                    'new_member' => $memberUsername
                ]);
                
                jsonResponse(true, ['username' => $memberUsername]);
            } catch (PDOException $e) {
                if (strpos($e->getMessage(), 'UNIQUE constraint') !== false) {
                    jsonResponse(false, null, 'User already in group');
                }
                throw $e;
            }
            break;
        
        case 'remove_group_member':
            $groupId = intval($input['group_id'] ?? 0);
            $memberUserId = intval($input['user_id'] ?? 0);
            
            if (empty($groupId) || empty($memberUserId)) {
                jsonResponse(false, null, 'Group ID and user ID required');
            }
            
            // Check permission
            $stmt = $db->prepare("
                SELECT role FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $userId]);
            $membership = $stmt->fetch();
            
            if (!$membership) {
                jsonResponse(false, null, 'Not a member of this group');
            }
            
            if ($membership['role'] !== 'admin' && $memberUserId !== $userId) {
                jsonResponse(false, null, 'Only admins can remove other members');
            }
            
            // Remove
            $stmt = $db->prepare("
                DELETE FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $memberUserId]);
            
            logAction($db, $userId, 'member_removed', 'group', $groupId);
            
            jsonResponse(true, ['removed' => $memberUserId]);
            break;
        
        case 'list_group_members':
            $groupId = intval($input['group_id'] ?? 0);
            
            if (empty($groupId)) {
                jsonResponse(false, null, 'Group ID required');
            }
            
            // Verify membership
            $stmt = $db->prepare("
                SELECT 1 FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $userId]);
            
            if (!$stmt->fetch()) {
                jsonResponse(false, null, 'Not a member of this group');
            }
            
            // Get members
            $stmt = $db->prepare("
                SELECT 
                    u.id,
                    u.username,
                    gm.role,
                    gm.joined_at,
                    COUNT(DISTINCT c.id) as copy_count
                FROM group_members gm
                JOIN users u ON gm.user_id = u.id
                LEFT JOIN copies c ON c.user_id = u.id
                WHERE gm.group_id = ?
                GROUP BY u.id
                ORDER BY gm.role DESC, u.username ASC
            ");
            $stmt->execute([$groupId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        case 'list_group_collection':
            $groupId = intval($input['group_id'] ?? 0);
            
            if (empty($groupId)) {
                jsonResponse(false, null, 'Group ID required');
            }
            
            // Verify membership
            $stmt = $db->prepare("
                SELECT 1 FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $userId]);
            
            if (!$stmt->fetch()) {
                jsonResponse(false, null, 'Not a member of this group');
            }
            
            // Get combined collection
            $stmt = $db->prepare("
                SELECT 
                    c.id as copy_id,
                    c.user_id as owner_id,
                    c.format,
                    c.edition,
                    c.region,
                    c.condition,
                    c.notes,
                    c.barcode,
                    c.created_at,
                    u.username as owner_name,
                    m.id as movie_id,
                    m.tmdb_id,
                    m.title,
                    m.display_title,
                    m.year,
                    m.poster_url,
                    m.rating,
                    m.runtime,
                    m.genre,
                    m.media_type,
                    m.overview,
                    m.director,
                    m.certification,
                    b.id as borrow_id,
                    b.borrower_id,
                    b.borrowed_at,
                    b.due_date,
                    b2.username as borrower_name
                FROM copies c
                JOIN users u ON c.user_id = u.id
                JOIN movies m ON c.movie_id = m.id
                JOIN group_members gm ON c.user_id = gm.user_id
                LEFT JOIN borrows b ON c.id = b.copy_id AND b.returned_at IS NULL
                LEFT JOIN users b2 ON b.borrower_id = b2.id
                WHERE gm.group_id = ?
                ORDER BY m.title ASC, u.username ASC
            ");
            $stmt->execute([$groupId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        case 'list_member_collection':
            $groupId = intval($input['group_id'] ?? 0);
            $memberUserId = intval($input['member_user_id'] ?? 0);
            
            if (empty($groupId) || empty($memberUserId)) {
                jsonResponse(false, null, 'Group ID and member user ID required');
            }
            
            // Verify both users are in group
            $stmt = $db->prepare("
                SELECT COUNT(*) as count FROM group_members
                WHERE group_id = ? AND user_id IN (?, ?)
            ");
            $stmt->execute([$groupId, $userId, $memberUserId]);
            
            if ($stmt->fetch()['count'] < 2) {
                jsonResponse(false, null, 'Not authorized');
            }
            
            // Get member's collection
            $stmt = $db->prepare("
                SELECT 
                    c.id as copy_id,
                    c.format,
                    c.edition,
                    c.region,
                    c.condition,
                    c.notes,
                    c.barcode,
                    c.created_at,
                    m.id as movie_id,
                    m.tmdb_id,
                    m.title,
                    m.year,
                    m.poster_url,
                    m.rating,
                    m.runtime,
                    m.genre,
                    m.media_type,
                    m.overview,
                    m.director,
                    m.certification,
                    b.id as borrow_id,
                    b.borrower_id,
                    b.borrowed_at,
                    b.due_date,
                    b2.username as borrower_name
                FROM copies c
                JOIN movies m ON c.movie_id = m.id
                LEFT JOIN borrows b ON c.id = b.copy_id AND b.returned_at IS NULL
                LEFT JOIN users b2 ON b.borrower_id = b2.id
                WHERE c.user_id = ?
                ORDER BY m.title ASC
            ");
            $stmt->execute([$memberUserId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;

        case 'update_group':
            $groupId = intval($input['group_id'] ?? 0);
            $name = sanitize($input['name'] ?? '', 100);
            $description = sanitize($input['description'] ?? '', 500);

            if (empty($groupId) || empty($name)) {
                jsonResponse(false, null, 'Group ID and name required');
            }

            // Check if user is admin of the group
            $stmt = $db->prepare("
                SELECT role FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $userId]);
            $membership = $stmt->fetch();

            if (!$membership || $membership['role'] !== 'admin') {
                jsonResponse(false, null, 'Only group admins can update group details');
            }

            // Update group
            $stmt = $db->prepare("
                UPDATE groups
                SET name = ?, description = ?
                WHERE id = ?
            ");
            $stmt->execute([$name, $description, $groupId]);

            jsonResponse(true, ['message' => 'Group updated successfully']);
            break;

        case 'delete_group':
            $groupId = intval($input['group_id'] ?? 0);

            if (empty($groupId)) {
                jsonResponse(false, null, 'Group ID required');
            }

            // Check if user is admin of the group
            $stmt = $db->prepare("
                SELECT role FROM group_members
                WHERE group_id = ? AND user_id = ?
            ");
            $stmt->execute([$groupId, $userId]);
            $membership = $stmt->fetch();

            if (!$membership || $membership['role'] !== 'admin') {
                jsonResponse(false, null, 'Only group admins can delete groups');
            }

            // Delete group members first (foreign key constraint)
            $stmt = $db->prepare("DELETE FROM group_members WHERE group_id = ?");
            $stmt->execute([$groupId]);

            // Delete the group
            $stmt = $db->prepare("DELETE FROM groups WHERE id = ?");
            $stmt->execute([$groupId]);

            jsonResponse(true, ['message' => 'Group deleted successfully']);
            break;

        // ========================================
        // BORROWING SYSTEM (NEW IN V3.0)
        // ========================================
        
        case 'borrow_copy':
            $copyId = intval($input['copy_id'] ?? 0);
            $dueDate = sanitize($input['due_date'] ?? '', 20);
            $notes = sanitize($input['notes'] ?? '', 500);
            
            if (empty($copyId)) {
                jsonResponse(false, null, 'Copy ID required');
            }
            
            // Get copy info
            $stmt = $db->prepare("
                SELECT c.user_id as owner_id, b.id as existing_borrow
                FROM copies c
                LEFT JOIN borrows b ON c.id = b.copy_id AND b.returned_at IS NULL
                WHERE c.id = ?
            ");
            $stmt->execute([$copyId]);
            $copy = $stmt->fetch();
            
            if (!$copy) {
                jsonResponse(false, null, 'Copy not found');
            }
            
            if ($copy['existing_borrow']) {
                jsonResponse(false, null, 'Copy already borrowed');
            }
            
            if ($copy['owner_id'] == $userId) {
                jsonResponse(false, null, 'Cannot borrow your own copy');
            }
            
            // Create borrow
            $stmt = $db->prepare("
                INSERT INTO borrows (copy_id, owner_id, borrower_id, due_date, notes)
                VALUES (?, ?, ?, ?, ?)
            ");
            $stmt->execute([
                $copyId,
                $copy['owner_id'],
                $userId,
                $dueDate ?: null,
                $notes
            ]);
            
            $borrowId = $db->lastInsertId();
            
            logAction($db, $userId, 'copy_borrowed', 'borrow', $borrowId);
            
            jsonResponse(true, ['borrow_id' => $borrowId]);
            break;
        
        case 'return_copy':
            $borrowId = intval($input['borrow_id'] ?? 0);
            
            if (empty($borrowId)) {
                jsonResponse(false, null, 'Borrow ID required');
            }
            
            // Verify authorization
            $stmt = $db->prepare("
                SELECT borrower_id, owner_id
                FROM borrows
                WHERE id = ? AND returned_at IS NULL
            ");
            $stmt->execute([$borrowId]);
            $borrow = $stmt->fetch();
            
            if (!$borrow) {
                jsonResponse(false, null, 'Active borrow not found');
            }
            
            if ($borrow['borrower_id'] != $userId && $borrow['owner_id'] != $userId) {
                jsonResponse(false, null, 'Not authorized');
            }
            
            // Mark returned
            $stmt = $db->prepare("
                UPDATE borrows
                SET returned_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ");
            $stmt->execute([$borrowId]);
            
            logAction($db, $userId, 'copy_returned', 'borrow', $borrowId);
            
            jsonResponse(true, ['returned' => $borrowId]);
            break;
        
        case 'list_borrowed':
            // What I borrowed
            $stmt = $db->prepare("
                SELECT 
                    b.id as borrow_id,
                    b.borrowed_at,
                    b.due_date,
                    b.notes,
                    c.id as copy_id,
                    c.format,
                    c.edition,
                    u.username as owner_name,
                    m.title,
                    m.year,
                    m.poster_url
                FROM borrows b
                JOIN copies c ON b.copy_id = c.id
                JOIN users u ON b.owner_id = u.id
                JOIN movies m ON c.movie_id = m.id
                WHERE b.borrower_id = ? AND b.returned_at IS NULL
                ORDER BY b.due_date ASC NULLS LAST, b.borrowed_at DESC
            ");
            $stmt->execute([$userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        case 'list_lent':
            // What I lent
            $stmt = $db->prepare("
                SELECT 
                    b.id as borrow_id,
                    b.borrowed_at,
                    b.due_date,
                    b.notes,
                    c.id as copy_id,
                    c.format,
                    c.edition,
                    u.username as borrower_name,
                    m.title,
                    m.year,
                    m.poster_url
                FROM borrows b
                JOIN copies c ON b.copy_id = c.id
                JOIN users u ON b.borrower_id = u.id
                JOIN movies m ON c.movie_id = m.id
                WHERE b.owner_id = ? AND b.returned_at IS NULL
                ORDER BY b.due_date ASC NULLS LAST, b.borrowed_at DESC
            ");
            $stmt->execute([$userId]);
            
            jsonResponse(true, $stmt->fetchAll());
            break;
        
        // ========================================
        // TRIVIA GAME ACTIONS
        // ========================================

        case 'trivia_start_game':
            $gameId = generateId();
            $mode = sanitize($input['mode'] ?? 'sprint', 20);
            $scope = sanitize($input['scope'] ?? 'collection', 20);
            $livesRemaining = ($mode === 'survival') ? 3 : 0;

            $stmt = $db->prepare("
                INSERT INTO trivia_games (id, user_id, mode, scope, lives_remaining)
                VALUES (?, ?, ?, ?, ?)
            ");
            $stmt->execute([$gameId, $userId, $mode, $scope, $livesRemaining]);

            logAction($db, $userId, 'trivia_game_started', 'trivia_game', $gameId);

            jsonResponse(true, ['game_id' => $gameId]);
            break;

        case 'trivia_save_question':
            $questionId = generateId();
            $gameId = sanitize($input['game_id'] ?? '', 50);
            $roundNumber = intval($input['round_number'] ?? 0);
            $question = sanitize($input['question'] ?? '', 500);
            $type = sanitize($input['type'] ?? '', 50);
            $difficulty = sanitize($input['difficulty'] ?? '', 20);
            $templateId = sanitize($input['template_id'] ?? '', 50);
            $choicesJson = json_encode($input['choices'] ?? []);
            $correctAnswer = sanitize($input['correct_answer'] ?? '', 200);
            $userAnswer = sanitize($input['user_answer'] ?? '', 200);
            $isCorrect = intval($input['is_correct'] ?? 0);
            $timeTaken = floatval($input['time_taken'] ?? 0);
            $pointsEarned = intval($input['points_earned'] ?? 0);
            $streakAtTime = intval($input['streak_at_time'] ?? 0);
            $questionHash = sanitize($input['question_hash'] ?? '', 100);
            $metadataJson = json_encode($input['metadata'] ?? []);

            $stmt = $db->prepare("
                INSERT INTO trivia_questions (
                    id, game_id, user_id, round_number, question, type, difficulty,
                    template_id, choices_json, correct_answer, user_answer, is_correct,
                    time_taken, points_earned, streak_at_time, question_hash, metadata_json
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ");
            $stmt->execute([
                $questionId, $gameId, $userId, $roundNumber, $question, $type, $difficulty,
                $templateId, $choicesJson, $correctAnswer, $userAnswer, $isCorrect,
                $timeTaken, $pointsEarned, $streakAtTime, $questionHash, $metadataJson
            ]);

            jsonResponse(true, ['question_id' => $questionId]);
            break;

        case 'trivia_update_game':
            $gameId = sanitize($input['game_id'] ?? '', 50);
            $questionsCount = intval($input['questions_count'] ?? 0);
            $correctCount = intval($input['correct_count'] ?? 0);
            $incorrectCount = intval($input['incorrect_count'] ?? 0);
            $score = intval($input['score'] ?? 0);
            $duration = intval($input['duration'] ?? 0);
            $completed = intval($input['completed'] ?? 0);
            $bestStreak = intval($input['best_streak'] ?? 0);
            $livesRemaining = intval($input['lives_remaining'] ?? 0);

            $stmt = $db->prepare("
                UPDATE trivia_games
                SET questions_count = ?,
                    correct_count = ?,
                    incorrect_count = ?,
                    score = ?,
                    duration = ?,
                    completed = ?,
                    best_streak = ?,
                    lives_remaining = ?,
                    completed_at = CASE WHEN ? = 1 THEN CURRENT_TIMESTAMP ELSE completed_at END
                WHERE id = ? AND user_id = ?
            ");
            $stmt->execute([
                $questionsCount, $correctCount, $incorrectCount, $score, $duration,
                $completed, $bestStreak, $livesRemaining, $completed, $gameId, $userId
            ]);

            jsonResponse(true, ['updated' => true]);
            break;

        case 'trivia_complete_game':
            $gameId = sanitize($input['game_id'] ?? '', 50);
            $mode = sanitize($input['mode'] ?? '', 20);
            $score = intval($input['score'] ?? 0);
            $questionsCount = intval($input['questions_count'] ?? 0);
            $correctCount = intval($input['correct_count'] ?? 0);
            $incorrectCount = intval($input['incorrect_count'] ?? 0);
            $bestStreak = intval($input['best_streak'] ?? 0);
            $duration = intval($input['duration'] ?? 0);

            // Update game as complete
            $stmt = $db->prepare("
                UPDATE trivia_games
                SET completed = 1,
                    completed_at = CURRENT_TIMESTAMP,
                    questions_count = ?,
                    correct_count = ?,
                    incorrect_count = ?,
                    score = ?,
                    duration = ?,
                    best_streak = ?
                WHERE id = ? AND user_id = ?
            ");
            $stmt->execute([
                $questionsCount, $correctCount, $incorrectCount, $score,
                $duration, $bestStreak, $gameId, $userId
            ]);

            // Get or create stats record
            $stmt = $db->prepare("SELECT * FROM trivia_stats WHERE user_id = ?");
            $stmt->execute([$userId]);
            $stats = $stmt->fetch();

            if (!$stats) {
                $stmt = $db->prepare("INSERT INTO trivia_stats (user_id) VALUES (?)");
                $stmt->execute([$userId]);
                $stmt = $db->prepare("SELECT * FROM trivia_stats WHERE user_id = ?");
                $stmt->execute([$userId]);
                $stats = $stmt->fetch();
            }

            // Update stats
            $newTotalGames = $stats['total_games'] + 1;
            $newTotalQuestions = $stats['total_questions'] + $questionsCount;
            $newCorrectAnswers = $stats['correct_answers'] + $correctCount;
            $newIncorrectAnswers = $stats['incorrect_answers'] + $incorrectCount;
            $newBestScore = max($stats['best_score'], $score);
            $newLongestStreak = max($stats['longest_streak'], $bestStreak);
            $newTotalTimePlayed = $stats['total_time_played'] + $duration;

            // Mode-specific stats
            $modeGamesField = $mode . '_games';
            $modeBestScoreField = $mode . '_best_score';
            $modeWinsField = ($mode === 'sprint') ? 'sprint_wins' : null;
            $modeBestRoundField = ($mode === 'endless' || $mode === 'survival') ? $mode . '_best_round' : null;

            $modeGames = $stats[$modeGamesField] + 1;
            $modeBestScore = max($stats[$modeBestScoreField], $score);

            $updateSql = "
                UPDATE trivia_stats
                SET total_games = ?,
                    total_questions = ?,
                    correct_answers = ?,
                    incorrect_answers = ?,
                    best_score = ?,
                    longest_streak = ?,
                    total_time_played = ?,
                    {$modeGamesField} = ?,
                    {$modeBestScoreField} = ?,
                    last_played_at = CURRENT_TIMESTAMP,
                    updated_at = CURRENT_TIMESTAMP
                WHERE user_id = ?
            ";

            $stmt = $db->prepare($updateSql);
            $stmt->execute([
                $newTotalGames, $newTotalQuestions, $newCorrectAnswers, $newIncorrectAnswers,
                $newBestScore, $newLongestStreak, $newTotalTimePlayed,
                $modeGames, $modeBestScore, $userId
            ]);

            logAction($db, $userId, 'trivia_game_completed', 'trivia_game', $gameId, [
                'score' => $score,
                'mode' => $mode,
                'questions' => $questionsCount,
                'correct' => $correctCount
            ]);

            jsonResponse(true, ['completed' => true]);
            break;

        case 'trivia_get_stats':
            $stmt = $db->prepare("SELECT * FROM trivia_stats WHERE user_id = ?");
            $stmt->execute([$userId]);
            $stats = $stmt->fetch();

            if (!$stats) {
                // Return empty stats
                jsonResponse(true, [
                    'total_games' => 0,
                    'total_questions' => 0,
                    'correct_answers' => 0,
                    'incorrect_answers' => 0,
                    'accuracy' => 0
                ]);
            }

            $accuracy = $stats['total_questions'] > 0
                ? round(($stats['correct_answers'] / $stats['total_questions']) * 100, 1)
                : 0;

            jsonResponse(true, array_merge($stats, ['accuracy' => $accuracy]));
            break;

        case 'trivia_get_history':
            $limit = intval($input['limit'] ?? 50);
            $offset = intval($input['offset'] ?? 0);

            $stmt = $db->prepare("
                SELECT
                    q.*,
                    g.mode,
                    g.scope,
                    g.score as game_score,
                    g.completed
                FROM trivia_questions q
                JOIN trivia_games g ON q.game_id = g.id
                WHERE q.user_id = ?
                ORDER BY q.created_at DESC
                LIMIT ? OFFSET ?
            ");
            $stmt->execute([$userId, $limit, $offset]);
            $questions = $stmt->fetchAll();

            // Decode JSON fields
            foreach ($questions as &$q) {
                $q['choices'] = json_decode($q['choices_json'], true);
                $q['metadata'] = json_decode($q['metadata_json'], true);
                unset($q['choices_json'], $q['metadata_json']);
            }

            jsonResponse(true, $questions);
            break;

        case 'trivia_get_recent_games':
            $limit = intval($input['limit'] ?? 10);

            $stmt = $db->prepare("
                SELECT *
                FROM trivia_games
                WHERE user_id = ?
                ORDER BY created_at DESC
                LIMIT ?
            ");
            $stmt->execute([$userId, $limit]);

            jsonResponse(true, $stmt->fetchAll());
            break;

        case 'trivia_get_used_hashes':
            // Get hashes of recently asked questions to avoid repeats
            $limit = intval($input['limit'] ?? 100);

            $stmt = $db->prepare("
                SELECT DISTINCT question_hash
                FROM trivia_questions
                WHERE user_id = ?
                ORDER BY created_at DESC
                LIMIT ?
            ");
            $stmt->execute([$userId, $limit]);

            $hashes = array_column($stmt->fetchAll(), 'question_hash');
            jsonResponse(true, $hashes);
            break;

        // ========================================
        // DEFAULT
        // ========================================

        default:
            jsonResponse(false, null, 'Unknown action: ' . $action);
    }
    
} catch (Exception $e) {
    error_log('CineShelf API Error: ' . $e->getMessage());
    error_log('Stack trace: ' . $e->getTraceAsString());
    jsonResponse(false, null, 'Server error: ' . $e->getMessage());
}